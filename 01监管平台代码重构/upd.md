## TRANS_R250425001_UPD  03


~~~sql

---更新作业表问题行数、最后执行时间
UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425001_J01  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425001_J01 ) AND A.IS_HX='否'
        ) 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425001_J01'
;

UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425001_J02  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425001_J02 ) AND A.IS_HX='否'
        ) 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425001_J02'
;

UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425001_J03  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425001_J03 ) AND A.IS_HX='否'
        ) 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425001_J03'
;

UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425001_J04  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425001_J04 ) AND A.IS_HX='否'
        ) 
    ,  IS_LAST_EXC='是' 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425001_J04'
;

---更新规则表问题行数、最后执行时间
UPDATE DWD_DATA_CHECK_RULE 
    SET ISSUE_LINE_COUNT = (
        SELECT  SUM(ISSUE_LINE_COUNT) FROM  DWD_DATA_CHECK_JOB   A 
        WHERE   RULE_CODE = 'R250425001'
        ) 
，RULE_CHECK_LAST_TIME =  (
        SELECT  JOB_LAST_RUN_TIME FROM  DWD_DATA_CHECK_JOB   A 
        WHERE   IS_LAST_EXC = '是' AND RULE_CODE = 'R250425001'
        ) 
,RULE_ALERT = (
	SELECT 
	CASE
		WHEN SUM(ISSUE_LINE_COUNT) > 0 THEN 1
		ELSE 0
	END
	FROM DWD_DATA_CHECK_JOB   A 
	WHERE RULE_CODE = 'R250425001'
)
,ETL_UPD_DT = SYSDATE
WHERE RULE_CODE = 'R250425001'
;
~~~


### 改


~~~sql
DECLARE
    TYPE t_job_list IS TABLE OF VARCHAR2(30);
    v_jobs t_job_list := t_job_list('J01', 'J02', 'J03', 'J04');
    v_sql  VARCHAR2(4000);
    v_new_data_count NUMBER;
BEGIN
    -- 动态处理所有JOB
    FOR i IN 1..v_jobs.COUNT LOOP
        EXECUTE IMMEDIATE '
            SELECT COUNT(*) 
            FROM DWD_R250425001_' || v_jobs(i) || ' 
            WHERE IS_NEW_DATA = ''是'''
        INTO v_new_data_count;

        IF v_new_data_count = 0 THEN
            v_sql := '
                UPDATE DWD_DATA_CHECK_JOB 
                SET ISSUE_LINE_COUNT = 0,
                    IS_LAST_EXC = ''是'',
                    JOB_LAST_RUN_TIME = SYSDATE
                WHERE JOB_CODE = ''R250425001_' || v_jobs(i) || '''';
        ELSE
            v_sql := '
                UPDATE DWD_DATA_CHECK_JOB 
                SET ISSUE_LINE_COUNT = (
                    SELECT COUNT(1) 
                    FROM DWD_R250425001_' || v_jobs(i) || ' 
                    WHERE CHECK_TIME = (SELECT MAX(CHECK_TIME) FROM DWD_R250425001_' || v_jobs(i) || ')
                      AND IS_HX = ''否''
                ),
                IS_LAST_EXC = ''是'',
                JOB_LAST_RUN_TIME = (SELECT MAX(CHECK_TIME) FROM DWD_R250425001_' || v_jobs(i) || ')
                WHERE JOB_CODE = ''R250425001_' || v_jobs(i) || '''';
        END IF;
        
        EXECUTE IMMEDIATE v_sql;
    END LOOP;

    -- 统一更新规则表
    UPDATE DWD_DATA_CHECK_RULE 
    SET ISSUE_LINE_COUNT = (
        SELECT SUM(ISSUE_LINE_COUNT) 
        FROM DWD_DATA_CHECK_JOB 
        WHERE RULE_CODE = 'R250425001'
    ),
    RULE_CHECK_LAST_TIME = (
        SELECT MAX(JOB_LAST_RUN_TIME) 
        FROM DWD_DATA_CHECK_JOB 
        WHERE IS_LAST_EXC = '是' 
          AND RULE_CODE = 'R250425001'
    ),
    RULE_ALERT = CASE
        WHEN (SELECT SUM(ISSUE_LINE_COUNT) FROM DWD_DATA_CHECK_JOB WHERE RULE_CODE = 'R250425001') > 0 THEN 1
        ELSE 0
    END,
    ETL_UPD_DT = SYSDATE
    WHERE RULE_CODE = 'R250425001';
END;
~~~


TRANS_R250425004_UPD 04

~~~sql

---更新作业表问题行数、最后执行时间
UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425004_J01  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425004_J01 ) AND A.IS_HX='否'
        ) 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425004_J01'
;

UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425004_J02  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425004_J02 ) AND A.IS_HX='否'
        ) 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425004_J02'
;

UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425004_J03  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425004_J03 ) AND A.IS_HX='否'
        ) 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425004_J03'
;

UPDATE DWD_DATA_CHECK_JOB 
    SET ISSUE_LINE_COUNT = (
        SELECT  COUNT(1) FROM  DWD_R250425004_J04  A 
        WHERE CHECK_TIME =( SELECT MAX(CHECK_TIME) FROM  DWD_R250425004_J04 ) AND A.IS_HX='否'
        ) 
    ,  IS_LAST_EXC='是' 
    ,JOB_LAST_RUN_TIME = SYSDATE
WHERE JOB_CODE = 'R250425004_J04'
;

---更新规则表问题行数、最后执行时间
UPDATE DWD_DATA_CHECK_RULE 
    SET ISSUE_LINE_COUNT = (
        SELECT  SUM(ISSUE_LINE_COUNT) FROM  DWD_DATA_CHECK_JOB   A 
        WHERE   RULE_CODE = 'R250425004'
        ) 
，RULE_CHECK_LAST_TIME =  (
        SELECT  JOB_LAST_RUN_TIME FROM  DWD_DATA_CHECK_JOB   A 
        WHERE   IS_LAST_EXC = '是' AND RULE_CODE = 'R250425004'
        ) 
,RULE_ALERT = (
	SELECT 
	CASE
		WHEN SUM(ISSUE_LINE_COUNT) > 0 THEN 1
		ELSE 0
	END
	FROM DWD_DATA_CHECK_JOB   A 
	WHERE RULE_CODE = 'R250425004'
)
,ETL_UPD_DT = SYSDATE
WHERE RULE_CODE = 'R250425004'
;

~~~


