CREATE TABLE "MDADS"."ADS_SALES_CAPACITY_ANALYSIS" 
   (	"SALE_PLATFORM_NAME" VARCHAR2(2000), 
	"SALE_REGION_NAME" VARCHAR2(2000), 
	"SALE_COMPANY_NAME" VARCHAR2(2000), 
	"CUSTOMER_NAME" VARCHAR2(2000), 
	"PRODUCTION_NAME" VARCHAR2(2000), 
	"CAPACITY_TYPE" VARCHAR2(2000), 
	"PRODUCT_SORT1" VARCHAR2(2000), 
	"PRODUCT_SORT2" VARCHAR2(2000), 
	"PRODUCT_SORT3" VARCHAR2(2000), 
	"BASE_M_FINISH_RATE" NUMBER, 
	"WEIGHT_M_TARGET_T" NUMBER, 
	"WEIGHT_M_ACTUAL_T" NUMBER, 
	"BASE_Q_FINISH_RATE" NUMBER, 
	"WEIGHT_Q_TARGET_T" NUMBER, 
	"WEIGHT_Q_ACTUAL_T" NUMBER, 
	"BASE_ACC_FINISH_RATE" NUMBER, 
	"WEIGHT_ACC_TARGET_T" NUMBER, 
	"WEIGHT_ACC_ACTUAL_T" NUMBER, 
	"ETL_CRT_DT" DATE DEFAULT SYSDATE, 
	"ETL_UPD_DT" DATE DEFAULT SYSDATE
   )

INSERT INTO
    MDADS.ADS_SALES_CAPACITY_ANALYSIS (
        PERIOD,  ---日期
        SALE_PLATFORM_NAME, -- 销售平台全称
        SALE_REGION_NAME, -- 销售大区全称
        SALE_COMPANY_NAME, -- 区域组织
        CUSTOMER_NAME, -- 客户名称
        PRODUCTION_NAME, -- 生产线
        CAPACITY_TYPE, -- 产能类型
        PRODUCT_SORT1, -- 产品大类
        PRODUCT_SORT2, -- 产品中类
        PRODUCT_SORT3, -- 产品小类
        BASE_M_FINISH_RATE, -- 月基准完成率
        WEIGHT_M_TARGET_T, -- 重量月度目标_吨
        WEIGHT_M_ACTUAL_T, -- 重量月度实际_吨
        BASE_Q_FINISH_RATE, -- 季度基准完成率
        WEIGHT_Q_TARGET_T, -- 重量季度目标_吨
        WEIGHT_Q_ACTUAL_T, -- 重量季度实际_吨
        BASE_ACC_FINISH_RATE, -- 月累计基准完成率
        WEIGHT_ACC_TARGET_T, -- 重量月累计目标_吨
        WEIGHT_ACC_ACTUAL_T, -- 重量月累计实际_吨
        WEIGHT_SAMEP_M_ACTUAL_T, -- 同期重量月度实际_吨
        WEIGHT_SAMEP_Q_ACTUAL_T, -- 同期重量季度实际_吨
        WEIGHT_SAMEP_ACC_ACTUAL_T -- 同期重量月累计实际_吨
    )

SELECT
    A.PERIOD,      ---日期
    A.ORG_NAME1, -- SALE_PLATFORM_NAME ,       -- 销售平台全称
    A.ORG_NAME2, -- SALE_REGION_NAME ,                  -- 销售大区全称
    A.ORG_NAME3, -- SALE_COMPANY_NAME ,                 -- 区域组织
    A.CUSTOMER_NAME, -- CUSTOMER_NAME ,                     -- 客户名称
    A.PRODUCT_LINE, -- PRODUCTION_NAME ,          -- 生产线
    B.CAPACITY_TYPE, -- CAPACITY_TYPE ,            -- 产能类型
    A.PRODUCT_SORT1, -- PRODUCT_SORT1 ,            -- 产品大类
    A.PRODUCT_SORT1, -- PRODUCT_SORT2 ,            -- 产品中类
    A.PRODUCT_SORT1, -- PRODUCT_SORT3 ,            -- 产品小类
    CASE
        WHEN A.WEIGHT_M_TARGET_T <= C.MIN_CAPACITY_T THEN 100
        ELSE C.MIN_CAPACITY_T / A.WEIGHT_M_TARGET_T * 100
    END AS BASE_M_FINISH_RATE, -- BASE_M_FINISH_RATE ,                -- 月基准完成率
    A.WEIGHT_M_TARGET_T, -- WEIGHT_M_TARGET_T ,               -- 重量月度目标_吨
    A.WEIGHT_M_ACTUAL_T_SAVE + A.WEIGHT_M_ACTUAL_T_UNSAVE, -- WEIGHT_M_ACTUAL_T ,               -- 重量月度实际_吨
    CASE
        WHEN A.WEIGHT_Q_TARGET_T <= C.MIN_CAPACITY_T * 3 THEN 100
        ELSE C.MIN_CAPACITY_T * 3 / A.WEIGHT_Q_TARGET_T * 100
    END AS BASE_Q_FINISH_RATE, -- BASE_Q_FINISH_RATE ,                -- 季度基准完成率
    A.WEIGHT_Q_TARGET_T, -- WEIGHT_Q_TARGET_T ,               -- 重量季度目标_吨
    A.WEIGHT_Q_ACTUAL_T_SAVE + A.WEIGHT_Q_ACTUAL_T_UNSAVE, -- WEIGHT_Q_ACTUAL_T ,               -- 重量季度实际_吨
    CASE
        WHEN A.WEIGHT_M_ACC_TARGET_T <= C.MIN_CAPACITY_T * (
            EXTRACT(
                MONTH
                FROM ADD_MONTHS (SYSDATE, -1)
            )
        ) THEN 100
        ELSE C.MIN_CAPACITY_T * (
            EXTRACT(
                MONTH
                FROM ADD_MONTHS (SYSDATE, -1)
            )
        ) / A.WEIGHT_M_ACC_TARGET_T * 100
    END AS BASE_ACC_FINISH_RATE, -- BASE_ACC_FINISH_RATE ,              -- 月累计基准完成率
    A.WEIGHT_M_ACC_TARGET_T, -- WEIGHT_ACC_TARGET_T ,              -- 重量月累计目标_吨
    A.WEIGHT_SAMEP_MACC_ACT_T_SAVE + A.WEIGHT_SAMEP_MACC_ACT_T_UNSAVE, -- WEIGHT_ACC_ACTUAL_T                -- 重量月累计实际_吨
    A.WEIGHT_SAMEP_M_ACTUAL_T_SAVE + WEIGHT_SAMEP_M_ACTUAL_T_UNSAVE ,-- 同期重量月度实际_吨
    A.WEIGHT_SAMEP_Q_ACTUAL_T_SAVE + A.WEIGHT_SAMEP_Q_ACTUAL_T_UNSAVE, -- 同期重量季度实际_吨
    A.WEIGHT_SAMEP_MACC_ACT_T_SAVE + A.WEIGHT_SAMEP_MACC_ACT_T_UNSAVE -- 同期重量月累计实际_吨
FROM
    MDDWS.DWS_PRODUCT_ORDER_REVENUE A --生产订单业绩汇总表
    -- LEFT JOIN MDDWD.DWD_CNLXDZB B -- 产能类型对照表
    -- ON A.PRODUCT_SORT1 = B.PRODUCT_SORT1
    -- AND A.PRODUCT_SORT2 = B.PRODUCT_SORT2
    -- AND A.PRODUCT_SORT3 = B.PRODUCT_SORT3
    -- AND A.PRODUCT_SORT4 = B.PRODUCT_SORT4
    LEFT JOIN  (
    SELECT DISTINCT PRODUCTION_LINE, PRODUCT_SORT1,PRODUCT_SORT2,PRODUCT_SORT3,PRODUCT_SORT4,CAPACITY_TYPE
    FROM MDDWD.DWD_CNLXDZB
    )B
    ON A.PRODUCT_SORT1=B.PRODUCT_SORT1
    AND A.PRODUCT_SORT2=B.PRODUCT_SORT2
    AND A.PRODUCT_SORT3=B.PRODUCT_SORT3
    LEFT JOIN MDDWD.DWD_CNJCB C ON A.ORG_NAME1 = C.PRODUCTION_LINE
    AND A.FACTORY_NAME = C.FACTORY
    AND B.CAPACITY_TYPE = C.CAPACITY_TYPE