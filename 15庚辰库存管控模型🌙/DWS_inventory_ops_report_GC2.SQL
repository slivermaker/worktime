CREATE TABLE DWS_INVENTORY_OPS_BEGIN (
    PERIOD DATE,                              -- 日期
    PRODUCT_TYPE_SC VARCHAR2(4000),          -- 产品类型
    PRODUCT_CODE VARCHAR2(4000),             -- 产品编码
    BEGINNING_INVENTORY NUMBER,              -- 期初结存量
    SAMEP_MONTH_INVENTORY NUMBER,             -- 同期期初结存量
    LAST_MONTH_INVENTORY NUMBER               -- 上月初结存量
);

COMMENT ON TABLE DWS_INVENTORY_OPS_BEGIN IS '期初结存量月度统计表（适用于庚辰库存运营）';


COMMENT ON COLUMN DWS_INVENTORY_OPS_BEGIN.PERIOD IS '统计日期';
COMMENT ON COLUMN DWS_INVENTORY_OPS_BEGIN.PRODUCT_TYPE_SC IS '产品类型分类';
COMMENT ON COLUMN DWS_INVENTORY_OPS_BEGIN.PRODUCT_CODE IS '产品编码';
COMMENT ON COLUMN DWS_INVENTORY_OPS_BEGIN.BEGINNING_INVENTORY IS '当月期初结存量';
COMMENT ON COLUMN DWS_INVENTORY_OPS_BEGIN.SAMEP_MONTH_INVENTORY IS '上年同月期初结存量';
COMMENT ON COLUMN DWS_INVENTORY_OPS_BEGIN.LAST_MONTH_INVENTORY IS '上月期初结存量';




SELECT 
    B.PERIOD
    ,A.PRODUCT_TYPE_SC        --类型  
    ,A.PRODUCT_CODE           --产品编码
    ,SUM(B.BEGINNING_INVENTORY) AS BEGINNING_INVENTORY               --期初结存
FROM 
    MDDWD.DWD_STKCFLB A
    LEFT JOIN  MDDWD.DWD_TPC_HWJCB B--货物结存表  取期初结存
    ON A.PRODUCT_CODE = (CASE WHEN B.PRODUCT_SPECIFICATION IS NULL OR B.PRODUCT_SPECIFICATION='' THEN B.PRODUCT_VARIETY ELSE B.PRODUCT_VARIETY ||'_'|| B.PRODUCT_SPECIFICATION END)  
WHERE
A.PRODUCT_CODE IN (
    SELECT PRODUCT_CODE
    FROM MDDWD.DWD_XSGXDYB C
    WHERE
        C.PRODUCT_SORT1 = '球铁'
        AND C.START_TIME <= SYSDATE
        AND C.END_TIME >= SYSDATE       --作为限制
) 

GROUP BY B.PERIOD,A.PRODUCT_TYPE_SC,A.PRODUCT_CODE







TRUNCATE TABLE MDDWS.DWS_INVENTORY_OPS_BEGIN;
INSERT INTO MDDWS.DWS_INVENTORY_OPS_BEGIN(
    PERIOD ,                              -- 日期
    PRODUCT_TYPE_SC ,          -- 产品类型
    PRODUCT_CODE ,             -- 产品编码
    BEGINNING_INVENTORY ,              
    SAMEP_MONTH_INVENTORY ,          
    LAST_MONTH_INVENTORY             

)

WITH TMP AS (
    SELECT 
        B.PERIOD,
        A.PRODUCT_TYPE_SC,
        A.PRODUCT_CODE,
        SUM(B.BEGINNING_INVENTORY) AS BEGINNING_INVENTORY
    FROM 
        MDDWD.DWD_STKCFLB A
        LEFT JOIN MDDWD.DWD_TPC_HWJCB B
        ON A.PRODUCT_CODE = (CASE WHEN B.PRODUCT_SPECIFICATION IS NULL OR B.PRODUCT_SPECIFICATION='' 
                               THEN B.PRODUCT_VARIETY 
                               ELSE B.PRODUCT_VARIETY ||'_'|| B.PRODUCT_SPECIFICATION END)  
    WHERE
        A.PRODUCT_CODE IN (
            SELECT PRODUCT_CODE
            FROM MDDWD.DWD_XSGXDYB C
            WHERE
                C.PRODUCT_SORT1 = '球铁'
                AND C.START_TIME <= SYSDATE
                AND C.END_TIME >= SYSDATE
        )
    GROUP BY 
        B.PERIOD,
        A.PRODUCT_TYPE_SC,
        A.PRODUCT_CODE
)



SELECT 
    PERIOD,             --日期
    PRODUCT_TYPE_SC,    --产品类型
    PRODUCT_CODE,
    BEGINNING_INVENTORY, --期初结存
    LAG(BEGINNING_INVENTORY, 12) OVER (PARTITION BY PRODUCT_TYPE_SC, PRODUCT_CODE ORDER BY PERIOD) AS SAMEP_MONTH_INVENTORY,  --同期结存
    LAG(BEGINNING_INVENTORY, 1) OVER (PARTITION BY PRODUCT_TYPE_SC, PRODUCT_CODE ORDER BY PERIOD) AS LAST_MONTH_INVENTORY       --上月结存  
FROM TMP
