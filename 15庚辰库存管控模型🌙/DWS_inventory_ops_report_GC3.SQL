CREATE TABLE DWS_INVENTORY_OPS_CK (
    PERIOD DATE,                              -- 日期
    PRODUCT_TYPE_SC VARCHAR2(4000),          -- 产品类型
    PRODUCT_CODE VARCHAR2(4000),             -- 产品编码
    MONTHLY_OUT_QUANTITY NUMBER,              -- 月出库量
    SAMEP_MONTH_OUT_QUANTITY NUMBER,          -- 同期出库量
    LAST_MONTH_OUT_QUANTITY NUMBER            -- 上月出库量
);

COMMENT ON TABLE DWS_INVENTORY_OPS_CK IS '月出库量统计表（适用于庚辰库存运营）';

COMMENT ON COLUMN DWS_INVENTORY_OPS_CK.PERIOD IS '统计日期';
COMMENT ON COLUMN DWS_INVENTORY_OPS_CK.PRODUCT_TYPE_SC IS '产品类型分类';
COMMENT ON COLUMN DWS_INVENTORY_OPS_CK.PRODUCT_CODE IS '产品编码';
COMMENT ON COLUMN DWS_INVENTORY_OPS_CK.MONTHLY_OUT_QUANTITY IS '当月出库量';
COMMENT ON COLUMN DWS_INVENTORY_OPS_CK.SAMEP_MONTH_OUT_QUANTITY IS '上年同月出库量';
COMMENT ON COLUMN DWS_INVENTORY_OPS_CK.LAST_MONTH_OUT_QUANTITY IS '上月出库量';




SELECT 
    TRUNC(TO_DATE(B.CKRQ,'YY.MM.DD'),'MM') AS PERIOD 
    ,A.PRODUCT_TYPE_SC        --类型  
    ,A.PRODUCT_CODE           --产品编码
    ,SUM(B.SL) AS MONTHLY_OUT_QUANTITY               --月出库量
FROM 
    MDDWD.DWD_STKCFLB A
    LEFT JOIN  ODS_ERP2013.ODS_XSCKSJ B--出库表  取出库量
    ON A.PRODUCT_CODE = B.WLBM 
WHERE
A.PRODUCT_CODE IN (
    SELECT PRODUCT_CODE
    FROM MDDWD.DWD_XSGXDYB C
    WHERE
        C.PRODUCT_SORT1 = '球铁'
        AND C.START_TIME <= SYSDATE
        AND C.END_TIME >= SYSDATE       --作为限制
) 

GROUP BY TRUNC(TO_DATE(B.CKRQ,'YY.MM.DD'),'MM'),A.PRODUCT_TYPE_SC,A.PRODUCT_CODE





TRUNCATE TABLE MDDWS.DWS_INVENTORY_OPS_CK;
INSERT INTO MDDWS.DWS_INVENTORY_OPS_CK(
    PERIOD ,                              -- 日期
    PRODUCT_TYPE_SC ,          -- 产品类型
    PRODUCT_CODE ,             -- 产品编码
    MONTHLY_OUT_QUANTITY ,              -- 月出库量
    SAMEP_MONTH_OUT_QUANTITY ,          -- 同期出库量
    LAST_MONTH_OUT_QUANTITY             -- 上月出库量

)



WITH TMP AS (
    SELECT 
        TRUNC(TO_DATE(B.CKRQ,'YY.MM.DD'),'MM') AS PERIOD,
        A.PRODUCT_TYPE_SC,
        A.PRODUCT_CODE,
        SUM(B.SL) AS MONTHLY_OUT_QUANTITY
    FROM 
        MDDWD.DWD_STKCFLB A
        LEFT JOIN ODS_ERP2013.ODS_XSCKSJ B
        ON A.PRODUCT_CODE = B.WLBM 
    WHERE
        A.PRODUCT_CODE IN (
            SELECT PRODUCT_CODE
            FROM MDDWD.DWD_XSGXDYB C
            WHERE
                C.PRODUCT_SORT1 = '球铁'
                AND C.START_TIME <= SYSDATE
                AND C.END_TIME >= SYSDATE
        )
        AND B.CKRQ IS NOT NULL
    GROUP BY 
        TRUNC(TO_DATE(B.CKRQ,'YY.MM.DD'),'MM'),
        A.PRODUCT_TYPE_SC,
        A.PRODUCT_CODE
)
SELECT 
    PERIOD,                         ---日期
    PRODUCT_TYPE_SC,                --产品类型
    PRODUCT_CODE,                   --产品编码
    MONTHLY_OUT_QUANTITY,            --月出库量   
    LAG(MONTHLY_OUT_QUANTITY, 12) OVER (PARTITION BY PRODUCT_TYPE_SC, PRODUCT_CODE ORDER BY PERIOD) AS SAMEP_MONTH_OUT_QUANTITY, --同期出库量
    LAG(MONTHLY_OUT_QUANTITY, 1) OVER (PARTITION BY PRODUCT_TYPE_SC, PRODUCT_CODE ORDER BY PERIOD) AS LAST_MONTH_OUT_QUANTITY       --上月出库量
FROM TMP




















SELECT 
    PERIOD,
    PRODUCT_TYPE_SC,
    PRODUCT_CODE,
    MONTHLY_OUT_QUANTITY,
    LAST_YEAR_SAME_MONTH,
    LAST_MONTH,
    CASE 
        WHEN LAST_MONTH = 0 THEN NULL
        ELSE ROUND((MONTHLY_OUT_QUANTITY - LAST_MONTH) * 100.0 / LAST_MONTH, 2)
    END AS MOM_GROWTH_RATE,
    CASE 
        WHEN LAST_YEAR_SAME_MONTH = 0 THEN NULL
        ELSE ROUND((MONTHLY_OUT_QUANTITY - LAST_YEAR_SAME_MONTH) * 100.0 / LAST_YEAR_SAME_MONTH, 2)
    END AS YOY_GROWTH_RATE
FROM (
    SELECT 
        TRUNC(TO_DATE(B.CKRQ,'YYYY.MM.DD'),'MM') AS PERIOD,
        A.PRODUCT_TYPE_SC,
        A.PRODUCT_CODE,
        SUM(B.SL) AS MONTHLY_OUT_QUANTITY,
        LAG(SUM(B.SL), 12) OVER (PARTITION BY A.PRODUCT_TYPE_SC, A.PRODUCT_CODE ORDER BY TRUNC(TO_DATE(B.CKRQ,'YYYY.MM.DD'),'MM')) AS LAST_YEAR_SAME_MONTH,
        LAG(SUM(B.SL), 1) OVER (PARTITION BY A.PRODUCT_TYPE_SC, A.PRODUCT_CODE ORDER BY TRUNC(TO_DATE(B.CKRQ,'YYYY.MM.DD'),'MM')) AS LAST_MONTH
    FROM 
        MDDWD.DWD_STKCFLB A
        LEFT JOIN ODS_ERP2013.ODS_XSCKSJ B
        ON A.PRODUCT_CODE = B.WLBM 
    WHERE
        A.PRODUCT_CODE IN (
            SELECT PRODUCT_CODE
            FROM MDDWD.DWD_XSGXDYB C
            WHERE
                C.PRODUCT_SORT1 = '球铁'
                AND C.START_TIME <= SYSDATE
                AND C.END_TIME >= SYSDATE
        )
        AND B.CKRQ IS NOT NULL
    GROUP BY 
        TRUNC(TO_DATE(B.CKRQ,'YYYY.MM.DD'),'MM'),
        A.PRODUCT_TYPE_SC,
        A.PRODUCT_CODE
)
ORDER BY PERIOD, PRODUCT_CODE