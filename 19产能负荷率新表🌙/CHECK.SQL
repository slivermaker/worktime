WITH TMP AS (
  SELECT TRUNC(PERIOD,'MM') AS PERIOD ,
         ORDER_CODE,
         PRODUCT_LINE,
         PRODUCT_SORT1,
         PRODUCT_SORT2,
         PRODUCT_SORT3,
         SUM(WEIHT_T) AS ZL
  FROM MDDWD.DWD_PRODUCT_ORDER A LEFT JOIN ODS_ERP.ODS_CNLXDZB B
  ON A.PRODUCT_LINE=B.SCX
  AND A.PRODUCT_SORT1=B.CPDL
  AND A.PRODUCT_SORT2=B.CPZL
  AND A.PRODUCT_SORT3=B.CPXL
  WHERE B.CNLX IS NULL AND PERIOD>=DATE'2025-06-1'AND A.PRODUCT_LINE='迈科管道'
         GROUP BY PERIOD,
         ORDER_CODE,
         PRODUCT_LINE,
         PRODUCT_SORT1,
         PRODUCT_SORT2,
         PRODUCT_SORT3
)
       
SELECT PERIOD,SUM(ZL) FROM TMP GROUP BY PERIOD



with tmp as (
SELECT A.period , 
       c.production_line,
       A.PRODUCT_LINE,
       A.ORDER_CODE,
       a.ITEM_CATE as 品种,
       a. ITEM_SPEC as 规格,
       a.ITEM_STYLE as 形式,
       A.PRODUCT_SORT1,
       A.PRODUCT_SORT2,
       A.PRODUCT_SORT3,
      B.CAPACITY_TYPE,
       sum(A.WEIHT_T) as weight,
       A.IS_SAVE_ORDER
        FROM MDDWD.DWD_PRODUCT_ORDER A
    LEFT JOIN(
        SELECT PRODUCTION_LINE,
            PRODUCT_SORT1,
            PRODUCT_SORT2,
            PRODUCT_SORT3,
            CAPACITY_TYPE
        FROM MDDWD.DWD_CNLXDZB
        GROUP BY PRODUCTION_LINE,
            PRODUCT_SORT1,
            PRODUCT_SORT2,
            PRODUCT_SORT3,
            CAPACITY_TYPE
    )  B
    ON CASE WHEN A.PRODUCT_LINE = '母公司' THEN a.MANU_DEPARTMENT ELSE A.PRODUCT_LINE END =B.PRODUCTION_LINE AND A.PRODUCT_SORT1=B.PRODUCT_SORT1
    AND A.PRODUCT_SORT2=B.PRODUCT_SORT2 AND A.PRODUCT_SORT3=B.PRODUCT_SORT3
        left join(
        SELECT distinct
            production_line,
            produce_company_name_sn
        FROM mddwd.dwd_cnlxdzb
    
    )c on C.PRODUCTION_LINE=CASE WHEN A.PRODUCT_LINE = '母公司' THEN a.MANU_DEPARTMENT ELSE A.PRODUCT_LINE END
    WHERE A.PERIOD>=DATE'2025-01-01'  
    and c.PRODUCTION_LINE is not null
    group by 
    A.period , 
    c.production_line,
       A.ORDER_CODE,
       a.ITEM_CATE,
       a. ITEM_SPEC,
       a.ITEM_STYLE,
       A.PRODUCT_LINE,
       A.PRODUCT_SORT1,
       A.PRODUCT_SORT2,
       A.PRODUCT_SORT3,
       B.CAPACITY_TYPE,
       A.IS_SAVE_ORDER
)
select * from tmp 
where PRODUCTION_LINE='山东晨晖' 
AND TRUNC(PERIOD,'MM')=DATE'2025-10-1' 




